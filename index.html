<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Teacher Payslip AI</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@400;700&family=Great+Vibes&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                        khmer: ['Battambang', 'Inter', 'ui-sans-serif'],
                        thai: ['Noto Sans Thai', 'sans-serif'],
                        sig: ['Great Vibes', 'cursive']
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-font-smoothing: antialiased;
        }
        /* Print Specifics */
        
        @media print {
            @page {
                margin: 0;
                size: auto;
            }
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            header,
            main,
            #modal-preview,
            #modal-contact,
            .mobile-ai-btn {
                display: none !important;
            }
            #print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                min-height: 100vh;
                margin: 0;
                padding: 0;
                background: white;
                z-index: 99999;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        .animate-up {
            animation: fadeUp 0.4s ease-out forwards;
        }
        
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 transition-colors duration-300 min-h-screen flex flex-col font-sans">

    <!-- Navbar -->
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2.5">
                <div class="bg-brand-600 text-white p-1.5 rounded-lg shadow-lg shadow-brand-500/30">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-xl tracking-tight text-slate-800 dark:text-white hidden sm:block">GlobalTeacher<span class="text-brand-600">AI</span></h1>
                <h1 class="font-bold text-lg tracking-tight text-slate-800 dark:text-white sm:hidden">Payslip<span class="text-brand-600">AI</span></h1>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <!-- Country Selector -->
                <div class="relative group min-w-[140px] md:min-w-[200px]">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 z-10">
                        <span id="flag-icon" class="text-lg">üá∞üá≠</span>
                    </div>
                    <select id="country-selector" onchange="app.updateCountryIcon()" class="w-full pl-10 pr-8 py-2 bg-slate-100 dark:bg-slate-800 border-none rounded-full text-xs md:text-sm font-semibold text-slate-700 dark:text-slate-300 focus:ring-2 focus:ring-brand-500 outline-none appearance-none cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                        <option value="kh">Cambodia (·ûÄ·ûò·üí·ûñ·ûª·ûá·û∂)</option>
                        <option value="us">USA (·ûü·û†·ûö·ûä·üí·ûã·û¢·û∂·ûò·üÅ·ûö·û∑·ûÄ)</option>
                        <option value="uk">UK (·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü)</option>
                        <option value="au">Australia (·û¢·ûº·ûü·üí·ûè·üí·ûö·û∂·ûõ·û∏)</option>
                        <option value="ca">Canada (·ûÄ·û∂·ûé·û∂·ûä·û∂)</option>
                        <option value="nl">Netherlands (·û†·ûº·û°·ûÑ·üã)</option>
                        <option value="cn">China (·ûÖ·û∑·ûì)</option>
                        <option value="th">Thailand (·ûê·üÉ)</option>
                        <option value="vn">Vietnam (·ûú·üÄ·ûè·ûé·û∂·ûò)</option>
                        <option value="id">Indonesia (·û•·ûé·üí·ûå·ûº·ûì·üÅ·ûü·üä·û∏)</option>
                        <option value="in">India (·û•·ûé·üí·ûå·û∂)</option>
                        <option value="pk">Pakistan (·ûî·üâ·û∂·ûÇ·û∏·ûü·üí·ûê·û∂·ûì)</option>
                        <option value="bd">Bangladesh (·ûî·ûÑ·üã·ûÄ·üí·ûõ·û∂·ûä·üÇ·ûü)</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400">
                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                    </div>
                </div>

                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 hidden md:block"></div>

                <button onclick="app.aiAutoFill()" class="hidden md:flex items-center gap-2 px-4 py-2 rounded-full bg-brand-50 dark:bg-slate-800 hover:bg-brand-100 dark:hover:bg-slate-700 text-brand-600 dark:text-brand-400 font-bold text-xs transition active:scale-95 border border-brand-200 dark:border-slate-700"
                    title="Generate Teacher Data">
                    <i data-lucide="wand-2" class="w-3.5 h-3.5"></i>
                    <span>AI Fill</span>
                </button>

                <!-- Support Button -->
                <button onclick="app.openContact()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition" title="Contact Support">
                    <i data-lucide="life-buoy" class="w-5 h-5"></i>
                </button>

                <button onclick="app.toggleLang()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition text-xs font-bold text-slate-600 dark:text-slate-300">
                    <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                    <span id="lang-label">EN</span>
                </button>
                <button onclick="app.toggleTheme()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile AI Button -->
    <div class="md:hidden px-4 py-3 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex gap-3 justify-center mobile-ai-btn">
        <button onclick="app.aiAutoFill()" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-bold text-sm shadow-md shadow-brand-500/20 active:scale-95 transition">
            <i data-lucide="wand-2" class="w-4 h-4"></i>
            <span>AI Auto-Fill</span>
        </button>
        <button onclick="app.resetForm()" class="px-4 py-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold active:scale-95 transition">
            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto w-full p-4 md:p-8 space-y-6">

        <!-- Tabs -->
        <div class="flex justify-center mb-2">
            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-1.5 rounded-2xl inline-flex backdrop-blur-sm">
                <button onclick="app.setTab('payslip')" id="btn-tab-payslip" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm bg-white text-brand-600 dark:bg-slate-700 dark:text-brand-300">
                    <span data-t="tab_payslip">Payslip Generator</span>
                </button>
                <button onclick="app.setTab('letter')" id="btn-tab-letter" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-700 dark:text-slate-400">
                    <span data-t="tab_letter">Official Letter</span>
                </button>
            </div>
        </div>

        <!-- Editor Panel -->
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-black/20 border border-slate-100 dark:border-slate-800 overflow-hidden transition-all duration-300 animate-up">

            <!-- Payslip Form -->
            <div id="panel-payslip" class="p-6 md:p-8 space-y-8">

                <!-- Section 1: Company + Images -->
                <section class="space-y-5">
                    <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2">
                        <i data-lucide="school" class="w-4 h-4 text-slate-400"></i>
                        <h2 class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400" data-t="sec_company">School / Institution Details</h2>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_company">School Name</label>
                                <input type="text" id="inp-company" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white"
                                    value="Phnom Penh International School">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_address">Address</label>
                                <input type="text" id="inp-address" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white"
                                    value="St. 2004, Phnom Penh, Cambodia">
                            </div>
                        </div>

                        <!-- Image Uploads -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Logo Upload -->
                            <div class="space-y-1.5">
                                <div class="flex justify-between items-center px-1">
                                    <label class="text-xs font-semibold text-slate-500">School Logo</label>
                                    <button onclick="app.generateLogo()" class="text-brand-600 hover:text-brand-700 text-[10px] font-bold flex items-center gap-1 transition">
                                        <i data-lucide="wand-2" class="w-3 h-3"></i> Generate
                                    </button>
                                </div>
                                <div class="relative group">
                                    <input type="file" id="inp-logo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleImage(this, 'preview-logo')">
                                    <div class="w-full h-[84px] bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex flex-col items-center justify-center text-slate-400 hover:border-brand-400 hover:text-brand-500 transition relative overflow-hidden">
                                        <img id="preview-logo" class="h-16 w-auto object-contain hidden z-0">
                                        <div id="placeholder-logo" class="flex flex-col items-center">
                                            <i data-lucide="image-plus" class="w-5 h-5 mb-1"></i>
                                            <span class="text-[10px] font-medium">Upload / Drop</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Signature Upload -->
                            <div class="space-y-1.5">
                                <div class="flex justify-between items-center px-1">
                                    <label class="text-xs font-semibold text-slate-500">Sign & Stamp</label>
                                    <button onclick="app.generateSignature()" class="text-brand-600 hover:text-brand-700 text-[10px] font-bold flex items-center gap-1 transition">
                                        <i data-lucide="wand-2" class="w-3 h-3"></i> Generate
                                    </button>
                                </div>
                                <div class="relative group">
                                    <input type="file" id="inp-sig" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleImage(this, 'preview-sig')">
                                    <div class="w-full h-[84px] bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex flex-col items-center justify-center text-slate-400 hover:border-brand-400 hover:text-brand-500 transition relative overflow-hidden">
                                        <img id="preview-sig" class="h-16 w-auto object-contain hidden z-0">
                                        <div id="placeholder-sig" class="flex flex-col items-center">
                                            <i data-lucide="pen-tool" class="w-5 h-5 mb-1"></i>
                                            <span class="text-[10px] font-medium">Upload / Drop</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Employee -->
                <section class="space-y-5">
                    <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2">
                        <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                        <h2 class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400" data-t="sec_employee">Teacher Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_name">Name</label>
                            <input type="text" id="inp-name" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white" value="Sophea Oun">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_id">Teacher ID</label>
                            <input type="text" id="inp-id" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white" value="TCH-2025-001">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_position">Position</label>
                            <input type="text" id="inp-position" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white"
                                value="English Teacher">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_dept">Department/Faculty</label>
                            <input type="text" id="inp-dept" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white" value="Foreign Languages">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_paydate">Pay Date</label>
                            <input type="date" id="inp-paydate" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white"
                                value="2025-11-30">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1" data-t="lbl_period">Period</label>
                            <input type="text" id="inp-period" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 outline-none transition dark:text-white"
                                value="Nov 1 - Nov 30, 2025">
                        </div>
                    </div>
                </section>

                <!-- Section 3: Financials -->
                <div class="grid md:grid-cols-2 gap-8 md:gap-12">
                    <!-- Earnings -->
                    <section class="space-y-4">
                        <div class="flex justify-between items-center border-b border-green-100 dark:border-green-900 pb-2">
                            <div class="flex items-center gap-2 text-green-600 dark:text-green-400">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                <h2 class="text-xs font-bold uppercase tracking-wider" data-t="sec_earnings">Earnings</h2>
                            </div>
                            <button onclick="app.addItem('earning')" class="text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 p-1.5 rounded-md hover:bg-green-50 dark:hover:bg-green-900/30 transition">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="list-earnings" class="space-y-3"></div>
                    </section>

                    <!-- Deductions -->
                    <section class="space-y-4">
                        <div class="flex justify-between items-center border-b border-red-100 dark:border-red-900 pb-2">
                            <div class="flex items-center gap-2 text-red-600 dark:text-red-400">
                                <i data-lucide="trending-down" class="w-4 h-4"></i>
                                <h2 class="text-xs font-bold uppercase tracking-wider" data-t="sec_deductions">Deductions</h2>
                            </div>
                            <button onclick="app.addItem('deduction')" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30 transition">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="list-deductions" class="space-y-3"></div>
                    </section>
                </div>
            </div>

            <!-- Letter Form -->
            <div id="panel-letter" class="hidden p-6 md:p-8 space-y-8 animate-up">
                <section class="space-y-4">
                    <div class="flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2">
                        <i data-lucide="mail" class="w-4 h-4 text-slate-400"></i>
                        <h2 class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Letter Details</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1">Recipient Name</label>
                            <input type="text" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm dark:text-white" placeholder="e.g. Embassy of ..." value="To Whom It May Concern">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-semibold text-slate-500 ml-1">Letter Content</label>
                            <textarea rows="8" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg px-3.5 py-2.5 text-sm dark:text-white" placeholder="Type your letter here...">This letter is to confirm that Sophea Oun is currently employed as an English Teacher at Phnom Penh International School. They have been working with us since September 2025.</textarea>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Footer Actions -->
            <div class="bg-slate-50 dark:bg-slate-800/50 p-6 md:px-8 border-t border-slate-200 dark:border-slate-800">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                    <div id="totals-area" class="w-full lg:w-auto flex flex-col items-end gap-1.5">
                        <div class="flex justify-between w-full lg:w-64 text-sm text-slate-500 dark:text-slate-400">
                            <span data-t="total_earn">Total Earnings</span>
                            <span class="font-mono font-semibold text-green-600 dark:text-green-400" id="val-total-earn">0.00</span>
                        </div>
                        <div class="flex justify-between w-full lg:w-64 text-sm text-slate-500 dark:text-slate-400">
                            <span data-t="total_ded">Total Deductions</span>
                            <span class="font-mono font-semibold text-red-600 dark:text-red-400" id="val-total-ded">0.00</span>
                        </div>
                        <div class="flex justify-between w-full lg:w-64 items-center pt-3 mt-1 border-t border-slate-200 dark:border-slate-700">
                            <span class="text-base font-bold text-slate-700 dark:text-white" data-t="net_pay">Net Pay</span>
                            <span class="font-mono text-xl font-bold text-brand-600 dark:text-brand-400" id="val-net-pay">0.00</span>
                        </div>
                    </div>

                    <div class="flex w-full lg:w-auto gap-3">
                        <button onclick="app.resetForm()" class="hidden lg:flex px-4 py-4 rounded-xl bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-300 dark:hover:bg-slate-700 transition" title="Reset Form">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                        <button onclick="app.openPreview()" class="w-full px-8 py-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg shadow-brand-500/25 active:scale-95 transition flex items-center justify-center gap-2.5">
                            <i data-lucide="file-check-2" class="w-5 h-5"></i>
                            <span data-t="btn_generate" class="text-base">Generate PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center text-slate-400 text-xs py-4">
            Global Teacher Payslip System ‚Ä¢ Secure & Standardized
        </div>
    </main>

    <!-- Preview / Print Modal -->
    <div id="modal-preview" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 print:hidden animate-up">
        <div class="bg-white dark:bg-slate-800 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-4 px-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <i data-lucide="eye" class="w-4 h-4 text-brand-500"></i> Preview
                </h3>
                <button onclick="app.closePreview()" class="text-slate-400 hover:text-red-500 transition p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-auto bg-slate-100 dark:bg-slate-950 p-4 md:p-8 flex justify-center">
                <!-- A4 Paper Representation -->
                <div id="paper-preview" class="bg-white text-slate-900 w-full max-w-[210mm] min-h-[297mm] shadow-xl p-[10mm] md:p-[15mm] origin-top scale-100 md:scale-100 transition-transform font-serif relative">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Actions -->
            <div class="p-4 px-6 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 flex-wrap">
                <button onclick="app.closePreview()" class="px-5 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">Close</button>

                <!-- Browser Print -->
                <button onclick="app.printDocument()" class="px-5 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-bold flex items-center gap-2 transition">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print
                </button>

                <!-- HTML2PDF Download -->
                <button id="btn-download-pdf" onclick="app.downloadPDF()" class="px-6 py-2.5 rounded-lg bg-brand-600 hover:bg-brand-700 text-white font-bold shadow-lg shadow-brand-500/20 flex items-center gap-2 transition transform hover:-translate-y-0.5">
                    <i data-lucide="download" class="w-4 h-4"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Contact Support Modal -->
    <div id="modal-contact" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 print:hidden animate-up">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 px-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <i data-lucide="life-buoy" class="w-4 h-4 text-brand-500"></i> Contact Support
                </h3>
                <button onclick="app.closeContact()" class="text-slate-400 hover:text-red-500 transition p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500">Your Name</label>
                    <input type="text" id="contact-name" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500">Email Address</label>
                    <input type="email" id="contact-email" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500">Message</label>
                    <textarea id="contact-message" rows="4" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm dark:text-white focus:ring-2 focus:ring-brand-500 outline-none"></textarea>
                </div>
            </div>
            <div class="p-4 px-6 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                <button onclick="app.closeContact()" class="px-4 py-2 rounded-lg text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition text-sm">Cancel</button>
                <button onclick="app.sendTelegramMessage()" class="px-5 py-2 rounded-lg bg-brand-600 hover:bg-brand-700 text-white font-bold shadow-md flex items-center gap-2 transition text-sm"><i data-lucide="send" class="w-4 h-4"></i> Send Message</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Container -->
    <div id="print-container" class="hidden"></div>

    <script>
        const app = {
                state: {
                    lang: 'en',
                    theme: 'light',
                    tab: 'payslip',
                    currency: '$',
                    country: 'kh',
                    images: {
                        logo: null,
                        sig: null
                    },
                    earnings: [{
                        id: 1,
                        desc: "Base Salary",
                        qty: "",
                        rate: "",
                        amount: 650.00
                    }, {
                        id: 2,
                        desc: "Extra Class Bonus",
                        qty: "",
                        rate: "",
                        amount: 120.00
                    }],
                    deductions: [{
                        id: 1,
                        desc: "Tax",
                        amount: 35.00
                    }, {
                        id: 2,
                        desc: "NSSF",
                        amount: 5.00
                    }]
                },

                // Config
                config: {
                    googleApiKey: "AIzaSyDEJ8J8giEYKXvhP5mo5hY1Nbm9y3laZiQ",
                    telegramBotToken: "8273106488:AAHHTDMqoZemCK563T-YQMB4arMYl5Ntq-w",
                    telegramChatId: 1126254088
                },

                aiData: {
                    kh: {
                        companies: ["·ûú·û∑·ûë·üí·ûô·û∂·ûõ·üê·ûô·ûî·û∂·ûÄ·üã·ûë·ûº·ûÄ", "·ûú·û∑·ûë·üí·ûô·û∂·ûõ·üê·ûô·ûñ·üí·ûö·üá·ûü·üä·û∏·ûü·ûª·ûú·ûè·üí·ûê·û∑", "·ûü·û∂·ûÄ·ûõ·ûú·û∑·ûë·üí·ûô·û∂·ûõ·üê·ûô·ûó·ûº·ûò·û∑·ûì·üí·ûë·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ", "·ûü·û∂·ûõ·û∂·ûö·üÄ·ûì·ûü·ûª·ûú·ûé·üí·ûé·ûó·ûº·ûò·û∑", "Northbridge International School"],
                        addresses: ["·ûò·û†·û∂·ûú·û∑·ûê·û∏·ûö·ûª·ûü·üí·ûü·üä·û∏, ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ", "·ûò·û†·û∂·ûú·û∑·ûê·û∏·ûñ·üí·ûö·üá·ûì·ûö·üÑ·ûè·üí·ûè·ûò, ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ", "·ûï·üí·ûõ·ûº·ûú ·ü¢·ü†·ü†·ü§, ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ"],
                        names: ["·ûü·ûª·ûÅ·û∂ ·ûÖ·û∂·ûì·üã", "·ûä·û∂·ûö·üâ·û∂ ·ûÇ·ûπ·ûò", "·ûú·û∑·ûî·ûª·ûõ ·ûü·ûª·ûÅ", "·ûî·ûª·ûî·üí·ûï·û∂ ·ûÄ·üÇ·ûú", "Sophea Oun", "Rithy Chea"],
                        roles: ["·ûÇ·üí·ûö·ûº·ûî·ûÑ·üí·ûö·üÄ·ûì·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", "·ûÇ·üí·ûö·ûº·ûó·û∂·ûü·û∂·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü", "·ûÇ·üí·ûö·ûº·ûö·ûº·ûî·ûú·û∑·ûë·üí·ûô·û∂", "·ûÇ·üí·ûö·ûº·û¢·ûÄ·üí·ûü·ûö·ûü·û∂·ûü·üí·ûè·üí·ûö·ûÅ·üí·ûò·üÇ·ûö", "·ûÇ·üí·ûö·ûº·ûÇ·û∏·ûò·û∏·ûú·û∑·ûë·üí·ûô·û∂", "·ûÇ·üí·ûö·ûº·ûá·û∏·ûú·ûú·û∑·ûë·üí·ûô·û∂", "·ûÇ·üí·ûö·ûº·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûú·û∑·ûë·üí·ûô·û∂", "·ûÇ·üí·ûö·ûº·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂"],
                        depts: ["Academic Affairs", "Foreign Languages", "Science Faculty"],
                        bonuses: ["·ûî·üí·ûö·û∂·ûÄ·üã·ûò·üâ·üÑ·ûÑ·ûî·ûì·üí·ûê·üÇ·ûò", "·ûî·üí·ûö·û∂·ûÄ·üã·ûÄ·üÇ·ûî·üí·ûö·û°·ûÑ", "·ûî·üí·ûö·û∂·ûÄ·üã·ûö·ûÑ·üí·ûú·û∂·ûì·üã·ûÄ·û∂·ûö·ûÑ·û∂·ûö"],
                        baseSalaryDesc: "·ûî·üí·ûö·û∂·ûÄ·üã·ûÅ·üÇ·ûÇ·üÑ·ûõ",
                        taxDesc: "·ûñ·ûì·üí·ûí·ûõ·ûæ·ûî·üí·ûö·û∂·ûÄ·üã·ûî·üÄ·ûú·ûè·üí·ûü",
                        insDesc: "·ûî·üÅ·û°·û∂·ûá·û∂·ûè·û∑ (NSSF)",
                        currency: "$",
                        flag: "üá∞üá≠",
                        salaryRange: [300, 1200]
                    },
                    us: {
                        companies: ["Lincoln High School", "Harvard University", "MIT", "Stanford University", "New York Public School #42"],
                        addresses: ["123 Broadway, NY", "Massachusetts Ave, Cambridge, MA", "Sunset Blvd, LA"],
                        names: ["James Smith", "Emma Johnson", "Michael Brown", "Sarah Connor", "Robert Taylor"],
                        roles: ["Mathematics Teacher", "Science Teacher", "English Teacher", "History Teacher", "Art Teacher", "Music Teacher", "Physical Education Teacher", "Special Education Teacher"],
                        depts: ["Mathematics", "Science", "Humanities", "Arts"],
                        bonuses: ["Performance Bonus", "Coaching Stipend", "Summer School"],
                        baseSalaryDesc: "Base Salary",
                        taxDesc: "Federal Tax",
                        insDesc: "Health Insurance",
                        currency: "$",
                        flag: "üá∫üá∏",
                        salaryRange: [3500, 7000]
                    },
                    uk: {
                        companies: ["Oxford University", "Cambridge University", "Eton College", "London School of Economics", "Manchester Grammar School"],
                        addresses: ["Oxford, UK", "Cambridge, UK", "Westminster, London"],
                        names: ["Oliver Williams", "Charlotte Brown", "Harry Davis", "Emily Wilson"],
                        roles: ["Maths Teacher", "Science Teacher", "English Teacher", "History Teacher", "Geography Teacher", "Primary Teacher"],
                        depts: ["Science", "Mathematics", "English Literature"],
                        bonuses: ["Performance Pay", "Responsibility Allowance"],
                        baseSalaryDesc: "Basic Pay",
                        taxDesc: "Income Tax (PAYE)",
                        insDesc: "National Insurance",
                        currency: "¬£",
                        flag: "üá¨üáß",
                        salaryRange: [2500, 4500]
                    },
                    au: {
                        companies: ["University of Melbourne", "Sydney Grammar School", "Australian National University", "Brisbane State High"],
                        addresses: ["Parkville, VIC", "Acton, ACT", "Sydney, NSW"],
                        names: ["Jack Thompson", "Matilda Jones", "William Martin", "Ruby White"],
                        roles: ["Mathematics Teacher", "Science Teacher", "English Teacher", "PE Teacher", "Primary Teacher"],
                        depts: ["General Science", "Physical Education", "Arts"],
                        bonuses: ["Holiday Loading", "Performance Bonus"],
                        baseSalaryDesc: "Base Salary",
                        taxDesc: "PAYG Withholding",
                        insDesc: "Superannuation",
                        currency: "A$",
                        flag: "üá¶üá∫",
                        salaryRange: [4000, 7500]
                    },
                    ca: {
                        companies: ["University of Toronto", "McGill University", "Vancouver Technical Secondary", "Montreal High School"],
                        addresses: ["King's College Cir, Toronto", "Sherbrooke St, Montreal"],
                        names: ["Liam Smith", "Olivia Brown", "Noah Tremblay", "Emma Roy"],
                        roles: ["French Teacher", "Math Teacher", "Science Teacher", "English Teacher", "Social Studies Teacher"],
                        depts: ["French Studies", "Mathematics", "Social Sciences"],
                        bonuses: ["Extra-curricular Stipend", "Northern Allowance"],
                        baseSalaryDesc: "Regular Earnings",
                        taxDesc: "Income Tax",
                        insDesc: "CPP/EI",
                        currency: "CA$",
                        flag: "üá®üá¶",
                        salaryRange: [3800, 7000]
                    },
                    nl: {
                        companies: ["University of Amsterdam", "Delft University of Technology", "Erasmus University", "Leiden University"],
                        addresses: ["Amsterdam, NL", "Delft, NL", "Rotterdam, NL"],
                        names: ["Daan de Vries", "Sophie Jansen", "Sem Bakker", "Mila Visser"],
                        roles: ["Leraar Wiskunde", "Leraar Engels", "Leraar Nederlands", "Leraar Geschiedenis", "Leraar Aardrijkskunde"],
                        depts: ["Wiskunde", "Talen", "Natuurkunde"],
                        bonuses: ["Vakantiegeld", "Eindejaarsuitkering"],
                        baseSalaryDesc: "Salaris",
                        taxDesc: "Loonheffing",
                        insDesc: "Pensioenpremie",
                        currency: "‚Ç¨",
                        flag: "üá≥üá±",
                        salaryRange: [2800, 5000]
                    },
                    cn: {
                        companies: ["Peking University", "Tsinghua University", "Shanghai High School", "Beijing No.4 High School"],
                        addresses: ["Haidian District, Beijing", "Xuhui, Shanghai"],
                        names: ["Wang Wei", "Li Na", "Zhang Min", "Liu Yang"],
                        roles: ["Mathematics Teacher", "Chinese Teacher", "English Teacher", "Physics Teacher", "Chemistry Teacher"],
                        depts: ["Mathematics", "Chinese", "English"],
                        bonuses: ["Performance Bonus", "Housing Allowance"],
                        baseSalaryDesc: "Basic Salary",
                        taxDesc: "Individual Income Tax",
                        insDesc: "Social Insurance",
                        currency: "¬•",
                        flag: "üá®üá≥",
                        salaryRange: [8000, 20000]
                    },
                    th: {
                        companies: ["Chulalongkorn University", "Mahidol University", "Bangkok Patana School", "Triam Udom Suksa"],
                        addresses: ["Pathum Wan, Bangkok", "Salaya, Nakhon Pathom"],
                        names: ["Somchai Jai-dee", "Malee Srisuk", "Arthit Sun", "Kanya Moon"],
                        roles: ["Thai Teacher", "English Teacher", "Math Teacher", "Science Teacher", "Social Studies Teacher"],
                        depts: ["Education", "Science", "Arts"],
                        bonuses: ["Living Allowance", "Extra Teaching"],
                        baseSalaryDesc: "Salary",
                        taxDesc: "Withholding Tax",
                        insDesc: "Social Security",
                        currency: "‡∏ø",
                        flag: "üáπüá≠",
                        salaryRange: [20000, 60000]
                    },
                    vn: {
                        companies: ["Vietnam National University", "Hanoi - Amsterdam High School", "RMIT Vietnam", "Le Hong Phong High School"],
                        addresses: ["Cau Giay, Hanoi", "District 7, Ho Chi Minh City"],
                        names: ["Nguyen Van An", "Tran Thi Mai", "Le Hoang", "Pham Minh"],
                        roles: ["Mathematics Teacher", "Literature Teacher", "English Teacher", "Physics Teacher", "Chemistry Teacher"],
                        depts: ["Information Technology", "Languages", "Physics"],
                        bonuses: ["Tet Bonus", "Performance Bonus"],
                        baseSalaryDesc: "Basic Salary",
                        taxDesc: "PIT",
                        insDesc: "Social Insurance",
                        currency: "‚Ç´",
                        flag: "üáªüá≥",
                        salaryRange: [10000000, 30000000]
                    },
                    id: {
                        companies: ["University of Indonesia", "Bandung Institute of Technology", "Jakarta Intercultural School"],
                        addresses: ["Depok, West Java", "Bandung, West Java", "South Jakarta"],
                        names: ["Budi Santoso", "Siti Aminah", "Agus Setiawan", "Dewi Lestari"],
                        roles: ["Guru Matematika", "Guru Bahasa Indonesia", "Guru Bahasa Inggris", "Guru IPA", "Guru IPS"],
                        depts: ["Engineering", "Education", "Economics"],
                        bonuses: ["THR (Holiday Allowance)", "Performance Tunjangan"],
                        baseSalaryDesc: "Gaji Pokok",
                        taxDesc: "PPh 21",
                        insDesc: "BPJS",
                        currency: "Rp",
                        flag: "üáÆüá©",
                        salaryRange: [5000000, 15000000]
                    },
                    in: {
                        companies: ["IIT Bombay", "Delhi Public School", "Kendriya Vidyalaya", "University of Delhi"],
                        addresses: ["Powai, Mumbai", "RK Puram, New Delhi"],
                        names: ["Rahul Sharma", "Priya Patel", "Amit Singh", "Sneha Gupta"],
                        roles: ["Mathematics Teacher", "Science Teacher", "English Teacher", "Hindi Teacher", "Social Science Teacher"],
                        depts: ["Computer Science", "Physics", "Mathematics"],
                        bonuses: ["DA (Dearness Allowance)", "HRA"],
                        baseSalaryDesc: "Basic Pay",
                        taxDesc: "TDS",
                        insDesc: "PF (Provident Fund)",
                        currency: "‚Çπ",
                        flag: "üáÆüá≥",
                        salaryRange: [30000, 100000]
                    },
                    pk: {
                        companies: ["LUMS", "Aitchison College", "Karachi Grammar School", "NUST"],
                        addresses: ["Lahore, Punjab", "Clifton, Karachi", "H-12, Islamabad"],
                        names: ["Muhammad Ali", "Fatima Khan", "Ahmed Raza", "Zainab Bibi"],
                        roles: ["Mathematics Teacher", "English Teacher", "Urdu Teacher", "Science Teacher", "Islamiyat Teacher"],
                        depts: ["Sciences", "Humanities", "Business"],
                        bonuses: ["Ad-hoc Relief", "Medical Allowance"],
                        baseSalaryDesc: "Basic Pay",
                        taxDesc: "Income Tax",
                        insDesc: "G.P. Fund",
                        currency: "‚Ç®",
                        flag: "üáµüá∞",
                        salaryRange: [50000, 150000]
                    },
                    bd: {
                        companies: ["University of Dhaka", "Viqarunnisa Noon School", "BUET", "North South University"],
                        addresses: ["Nilkhet, Dhaka", "Bashundhara, Dhaka"],
                        names: ["Rahim Uddin", "Farhana Akter", "Abdul Karim", "Nusrat Jahan"],
                        roles: ["Bangla Teacher", "English Teacher", "Math Teacher", "Science Teacher", "Religion Teacher"],
                        depts: ["Bangla", "English", "CSE"],
                        bonuses: ["Festival Bonus", "Eid Bonus"],
                        baseSalaryDesc: "Basic Salary",
                        taxDesc: "Tax",
                        insDesc: "Provident Fund",
                        currency: "‡ß≥",
                        flag: "üáßüá©",
                        salaryRange: [25000, 80000]
                    }
                },

                dict: {
                    en: {
                        tab_payslip: "Payslip Generator",
                        tab_letter: "Official Letter",
                        sec_company: "School / Institution",
                        lbl_company: "School Name",
                        lbl_address: "Address",
                        sec_employee: "Teacher Info",
                        lbl_name: "Name",
                        lbl_id: "Teacher ID",
                        lbl_position: "Position",
                        lbl_dept: "Department",
                        lbl_paydate: "Pay Date",
                        lbl_period: "Pay Period",
                        sec_earnings: "Earnings",
                        sec_deductions: "Deductions",
                        total_earn: "Total Earnings",
                        total_ded: "Total Deductions",
                        net_pay: "Net Pay",
                        btn_generate: "Generate PDF"
                    },
                    km: {
                        tab_payslip: "·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûî·üê·ûé·üí·ûé·ûî·ûæ·ûÄ·ûî·üí·ûö·û∂·ûÄ·üã",
                        tab_letter: "·ûõ·û∑·ûÅ·û∑·ûè·ûï·üí·ûõ·ûº·ûú·ûÄ·û∂·ûö",
                        sec_company: "·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûü·û∂·ûõ·û∂/·ûü·üí·ûê·û∂·ûî·üê·ûì",
                        lbl_company: "·ûà·üí·ûò·üÑ·üá·ûü·û∂·ûõ·û∂",
                        lbl_address: "·û¢·û∂·ûü·ûô·ûä·üí·ûã·û∂·ûì",
                        sec_employee: "·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûÇ·üí·ûö·ûº·ûî·ûÑ·üí·ûö·üÄ·ûì",
                        lbl_name: "·ûà·üí·ûò·üÑ·üá",
                        lbl_id: "·û¢·ûè·üí·ûè·ûõ·üÅ·ûÅ",
                        lbl_position: "·ûè·ûΩ·ûì·û∂·ûë·û∏",
                        lbl_dept: "·ûì·û∂·ûô·ûÄ·ûä·üí·ûã·û∂·ûì",
                        lbl_paydate: "·ûê·üí·ûÑ·üÉ·ûî·ûæ·ûÄ·ûî·üí·ûö·û∂·ûÄ·üã",
                        lbl_period: "·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë",
                        sec_earnings: "·ûî·üí·ûö·û∂·ûÄ·üã·ûÖ·üÜ·ûé·ûº·ûõ",
                        sec_deductions: "·ûÄ·û∂·ûö·ûÄ·û∂·ûè·üã·ûî·üí·ûö·û∂·ûÄ·üã",
                        total_earn: "·ûÖ·üÜ·ûé·ûº·ûõ·ûü·ûö·ûª·ûî",
                        total_ded: "·ûÄ·û∂·ûè·üã·ûü·ûö·ûª·ûî",
                        net_pay: "·ûî·üí·ûö·û∂·ûÄ·üã·ûë·ûë·ûΩ·ûõ·ûî·û∂·ûì",
                        btn_generate: "·ûî·ûÑ·üí·ûÄ·ûæ·ûè PDF"
                    }
                },

                init() {
                    this.loadIcons();
                    this.renderLists();
                    this.updateTotals();
                    this.setLang('en');
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        this.state.theme = 'dark';
                        document.documentElement.classList.add('dark');
                        this.updateThemeIcon();
                    }
                    window.addEventListener('beforeprint', () => {
                        document.getElementById('print-container').innerHTML = this.generateHTML();
                    });
                    this.updateCountryIcon();
                },

                loadIcons() {
                    lucide.createIcons();
                },

                toggleTheme() {
                    this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                    document.documentElement.classList.toggle('dark');
                    this.updateThemeIcon();
                },

                updateThemeIcon() {
                    const icon = document.getElementById('theme-icon');
                    if (this.state.theme === 'dark') icon.setAttribute('data-lucide', 'sun');
                    else icon.setAttribute('data-lucide', 'moon');
                    lucide.createIcons();
                },

                toggleLang() {
                    this.setLang(this.state.lang === 'en' ? 'km' : 'en');
                },

                setLang(lang) {
                    this.state.lang = lang;
                    document.getElementById('lang-label').textContent = lang.toUpperCase();
                    if (lang === 'km') document.body.classList.add('font-khmer');
                    else document.body.classList.remove('font-khmer');
                    const t = this.dict[lang];
                    document.querySelectorAll('[data-t]').forEach(el => {
                        const key = el.getAttribute('data-t');
                        if (t[key]) el.textContent = t[key];
                    });
                },

                setTab(tab) {
                    this.state.tab = tab;
                    document.getElementById('panel-payslip').classList.toggle('hidden', tab !== 'payslip');
                    document.getElementById('panel-letter').classList.toggle('hidden', tab !== 'letter');
                    document.getElementById('totals-area').style.opacity = tab === 'payslip' ? '1' : '0';
                    const btnPay = document.getElementById('btn-tab-payslip');
                    const btnLet = document.getElementById('btn-tab-letter');
                    const activeClass = "bg-white text-brand-600 shadow-sm dark:bg-slate-700 dark:text-brand-300";
                    const inactiveClass = "text-slate-500 hover:text-slate-700 dark:text-slate-400";
                    if (tab === 'payslip') {
                        btnPay.className = `px-8 py-2.5 rounded-xl text-sm font-bold transition-all ${activeClass}`;
                        btnLet.className = `px-8 py-2.5 rounded-xl text-sm font-bold transition-all ${inactiveClass}`;
                    } else {
                        btnLet.className = `px-8 py-2.5 rounded-xl text-sm font-bold transition-all ${activeClass}`;
                        btnPay.className = `px-8 py-2.5 rounded-xl text-sm font-bold transition-all ${inactiveClass}`;
                    }
                },

                openContact() {
                    document.getElementById('modal-contact').classList.remove('hidden');
                    document.getElementById('modal-contact').classList.add('flex');
                },

                closeContact() {
                    document.getElementById('modal-contact').classList.add('hidden');
                    document.getElementById('modal-contact').classList.remove('flex');
                },

                async sendTelegramMessage(customMsg = null) {
                    let text = "";
                    if (customMsg) {
                        text = customMsg;
                    } else {
                        const name = document.getElementById('contact-name').value;
                        const email = document.getElementById('contact-email').value;
                        const msg = document.getElementById('contact-message').value;
                        if (!name || !msg) {
                            alert("Please fill Name and Message");
                            return;
                        }
                        text = `üì¨ *New Support Message*\n\nüë§ *Name:* ${name}\nüìß *Email:* ${email}\nüí¨ *Message:* ${msg}`;
                    }

                    try {
                        await fetch(`https://api.telegram.org/bot${this.config.telegramBotToken}/sendMessage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                chat_id: this.config.telegramChatId,
                                text: text,
                                parse_mode: 'Markdown'
                            })
                        });
                        if (!customMsg) {
                            alert("Message sent!");
                            this.closeContact();
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },

                updateCountryIcon() {
                    const sel = document.getElementById('country-selector');
                    const val = sel ? sel.value : this.state.country;
                    const flag = (this.aiData[val] && this.aiData[val].flag) || 'üåç';
                    document.getElementById('flag-icon').textContent = flag;
                },

                handleImage(input, previewId) {
                    const file = input.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.getElementById(previewId);
                            img.src = e.target.result;
                            img.classList.remove('hidden');
                            const key = previewId === 'preview-logo' ? 'logo' : 'sig';
                            this.state.images[key] = e.target.result;
                            const placeholderId = previewId === 'preview-logo' ? 'placeholder-logo' : 'placeholder-sig';
                            document.getElementById(placeholderId).classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                },

                // --- AI GENERATORS ---
                generateLogo() {
                    const name = document.getElementById('inp-company').value || "School";
                    const matches = name.match(/\b\w/g);
                    let initials = "";

                    if (matches) {
                        initials = matches.join('').substring(0, 3).toUpperCase();
                    } else {
                        initials = name.replace(/\s/g, '').substring(0, 3).toUpperCase();
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d');

                    // Draw Shield Background
                    ctx.fillStyle = "#0c4a6e"; // Slate-900
                    ctx.beginPath();
                    ctx.arc(100, 100, 95, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw Border
                    ctx.lineWidth = 5;
                    ctx.strokeStyle = "#e2e8f0";
                    ctx.stroke();

                    // Text
                    ctx.fillStyle = "white";
                    ctx.font = "bold 60px 'Inter', sans-serif";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(initials, 100, 100);

                    // Set result
                    const dataUrl = canvas.toDataURL();
                    this.state.images.logo = dataUrl;
                    const img = document.getElementById('preview-logo');
                    img.src = dataUrl;
                    img.classList.remove('hidden');
                    document.getElementById('placeholder-logo').classList.add('hidden');
                },

                generateSignature() {
                    // Determine context based on country
                    const country = document.getElementById('country-selector').value;
                    const isKhmer = country === 'kh';
                    const isChina = country === 'cn';
                    const isJapan = false; // Add if needed

                    // Random Authority Names
                    const authNames = {
                        kh: ["·ûì·û∂·ûô·ûÄ·ûü·û∂·ûõ·û∂", "·ûî·üí·ûö·ûí·û∂·ûì·ûÇ·ûé·ûì·üÅ·ûô·üí·ûô", "·ûî·ûé·üí·ûå·û∑·ûè ·ûü·ûª·ûÅ·û∂", "·ûõ·üÑ·ûÄ·ûÇ·üí·ûö·ûº·ûí·üÜ"],
                        cn: ["Ê†°Èïø", "Ë¥¢Âä°ÊÄªÁõë", "ÊïôÂØº‰∏ª‰ªª"],
                        us: ["Principal Skinner", "Dr. A. Dumbledore", "Mrs. McGonagall", "Mr. Belding"],
                        uk: ["Headmaster", "Bursar", "Head of School"],
                        default: ["Principal", "Director", "Head of Finance", "Dean"]
                    };

                    const list = authNames[country] || authNames.default;
                    const authority = list[Math.floor(Math.random() * list.length)];

                    const canvas = document.createElement('canvas');
                    canvas.width = 300;
                    canvas.height = 120;
                    const ctx = canvas.getContext('2d');

                    // Draw Signature (Fake Cursive)
                    ctx.font = isKhmer ? "bold 30px 'Battambang', serif" : "40px 'Great Vibes', cursive";
                    ctx.fillStyle = "#0000cc"; // Blue ink
                    // Generate a random initial + surname-like string for the signature visual
                    const sigText = country === 'kh' ? "·û†·ûè·üí·ûê·ûõ·üÅ·ûÅ·û∂" : (Math.random() > 0.5 ? "J. Smith" : "A. Johnson");
                    ctx.fillText(sigText, 40, 60);

                    // Draw Title below signature
                    ctx.font = "italic 14px 'Inter', sans-serif";
                    ctx.fillStyle = "#475569"; // Slate-600
                    ctx.fillText(authority, 40, 85);

                    // Draw Stamp
                    ctx.beginPath();
                    ctx.arc(220, 60, 45, 0, Math.PI * 2);
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = "rgba(220, 38, 38, 0.7)"; // Red-600 with opacity
                    ctx.stroke();

                    ctx.save();
                    ctx.translate(220, 60);
                    ctx.rotate(-0.2);
                    ctx.font = "bold 12px sans-serif";
                    ctx.fillStyle = "rgba(220, 38, 38, 0.7)";
                    ctx.textAlign = "center";
                    ctx.fillText(isKhmer ? "·ûü·û∂·ûõ·û∂·ûö·üÄ·ûì" : "SCHOOL", 0, -15);
                    ctx.fillText(isKhmer ? "·ûï·üí·ûõ·ûº·ûú·ûÄ·û∂·ûö" : "OFFICIAL", 0, 5);
                    ctx.font = "10px monospace";
                    ctx.fillText(new Date().getFullYear(), 0, 20);
                    ctx.restore();

                    const dataUrl = canvas.toDataURL();
                    this.state.images.sig = dataUrl;
                    const img = document.getElementById('preview-sig');
                    img.src = dataUrl;
                    img.classList.remove('hidden');
                    document.getElementById('placeholder-sig').classList.add('hidden');
                },

                aiAutoFill() {
                    const countryCode = document.getElementById('country-selector').value;
                    const data = this.aiData[countryCode];
                    this.state.currency = data.currency; // Update global currency
                    this.state.country = countryCode;

                    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
                    const rand = (min, max) => Math.floor(Math.random() * (max - min) + min);
                    const randSalary = (min, max) => {
                        const step = max > 10000 ? 500 : 50;
                        return (Math.floor(Math.random() * (max - min) / step) + min / step) * step;
                    };

                    document.getElementById('inp-company').value = pick(data.companies);
                    document.getElementById('inp-address').value = pick(data.addresses);
                    document.getElementById('inp-name').value = pick(data.names);
                    document.getElementById('inp-id').value = `TCH-${rand(1000, 9999)}`;
                    document.getElementById('inp-position').value = pick(data.roles);
                    document.getElementById('inp-dept').value = pick(data.depts);

                    const salaryRange = data.salaryRange || [1000, 3000];
                    let baseSalary = randSalary(salaryRange[0], salaryRange[1]);
                    let bonus = rand(0, 1) ? randSalary(salaryRange[0] * 0.1, salaryRange[0] * 0.3) : 0;
                    let tax = baseSalary * 0.15;
                    let insurance = baseSalary * 0.05;

                    this.state.earnings = [{
                        id: 1,
                        desc: data.baseSalaryDesc,
                        qty: "",
                        rate: "",
                        amount: baseSalary.toFixed(2)
                    }];
                    if (bonus > 0) this.state.earnings.push({
                        id: 2,
                        desc: pick(data.bonuses),
                        qty: "",
                        rate: "",
                        amount: bonus.toFixed(2)
                    });
                    this.state.deductions = [{
                        id: 1,
                        desc: data.taxDesc,
                        amount: tax.toFixed(2)
                    }, {
                        id: 2,
                        desc: data.insDesc,
                        amount: insurance.toFixed(2)
                    }];

                    // Auto generate logo/sig if empty
                    if (!this.state.images.logo) this.generateLogo();
                    if (!this.state.images.sig) this.generateSignature();

                    this.renderLists();
                    this.updateTotals();
                },

                resetForm() {
                    document.getElementById('inp-company').value = "";
                    document.getElementById('inp-address').value = "";
                    document.getElementById('inp-name').value = "";
                    document.getElementById('inp-id').value = "";
                    document.getElementById('inp-position').value = "";
                    document.getElementById('inp-dept').value = "";

                    // Reset images
                    this.state.images = {
                        logo: null,
                        sig: null
                    };
                    document.getElementById('preview-logo').classList.add('hidden');
                    document.getElementById('placeholder-logo').classList.remove('hidden');
                    document.getElementById('preview-sig').classList.add('hidden');
                    document.getElementById('placeholder-sig').classList.remove('hidden');
                    document.getElementById('inp-logo').value = "";
                    document.getElementById('inp-sig').value = "";

                    this.state.earnings = [{
                        id: 1,
                        desc: "Base Salary",
                        qty: "",
                        rate: "",
                        amount: ""
                    }];
                    this.state.deductions = [];
                    this.renderLists();
                    this.updateTotals();
                },

                addItem(type) {
                    const id = Date.now();
                    if (type === 'earning') this.state.earnings.push({
                        id,
                        desc: "",
                        qty: "",
                        rate: "",
                        amount: ""
                    });
                    else this.state.deductions.push({
                        id,
                        desc: "",
                        amount: ""
                    });
                    this.renderLists();
                },

                removeItem(type, id) {
                    if (type === 'earning') this.state.earnings = this.state.earnings.filter(x => x.id !== id);
                    else this.state.deductions = this.state.deductions.filter(x => x.id !== id);
                    this.renderLists();
                    this.updateTotals();
                },

                updateItem(type, id, field, val) {
                    const list = type === 'earning' ? this.state.earnings : this.state.deductions;
                    const item = list.find(x => x.id === id);
                    if (item) {
                        item[field] = val;
                        if (type === 'earning' && (field === 'qty' || field === 'rate')) {
                            const q = parseFloat(item.qty);
                            const r = parseFloat(item.rate);
                            if (!isNaN(q) && !isNaN(r)) {
                                item.amount = (q * r).toFixed(2);
                                const inp = document.getElementById(`amt-${type}-${id}`);
                                if (inp) inp.value = item.amount;
                            }
                        }
                    }
                    this.updateTotals();
                },

                renderLists() {
                    const renderRow = (item, type) => {
                            const isBase = type === 'earning' && (item.desc.toLowerCase().includes('base salary') || item.desc.includes('·ûî·üí·ûö·û∂·ûÄ·üã·ûÅ·üÇ·ûÇ·üÑ·ûõ') || item.desc.includes('Basic Pay') || item.desc.includes('Gaji Pokok') || item.desc.includes('Salaris'));
                            return `
                    <div class="grid grid-cols-12 gap-2 animate-up">
                        <div class="${type==='earning'?'col-span-5 md:col-span-6':'col-span-8'}">
                            <input type="text" placeholder="Description" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded px-2.5 py-2 text-sm dark:text-white outline-none focus:ring-1 focus:ring-brand-500" value="${item.desc}" oninput="app.updateItem('${type}', ${item.id}, 'desc', this.value)">
                        </div>
                        ${type==='earning' ? `
                        <div class="col-span-2">
                            ${isBase ? 
                                `<input type="text" disabled value="-" class="w-full bg-slate-50/50 dark:bg-slate-800/50 border-slate-100 dark:border-slate-800 rounded px-2.5 py-2 text-sm text-center text-slate-400 cursor-not-allowed">` :
                                `<input type="number" placeholder="Qty" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded px-2.5 py-2 text-sm dark:text-white outline-none focus:ring-1 focus:ring-brand-500" value="${item.qty}" oninput="app.updateItem('earning', ${item.id}, 'qty', this.value)">`
                            }
                        </div>
                        <div class="col-span-2">
                            ${isBase ? 
                                `<input type="text" disabled value="-" class="w-full bg-slate-50/50 dark:bg-slate-800/50 border-slate-100 dark:border-slate-800 rounded px-2.5 py-2 text-sm text-center text-slate-400 cursor-not-allowed">` :
                                `<input type="number" placeholder="Rate" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded px-2.5 py-2 text-sm dark:text-white outline-none focus:ring-1 focus:ring-brand-500" value="${item.rate}" oninput="app.updateItem('earning', ${item.id}, 'rate', this.value)">`
                            }
                        </div>
                        ` : ''}
                        <div class="${type==='earning'?'col-span-2':'col-span-3'}">
                             <input type="number" id="amt-${type}-${item.id}" placeholder="0.00" class="w-full bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded px-2.5 py-2 text-sm font-semibold text-right dark:text-white outline-none focus:ring-1 focus:ring-brand-500" value="${item.amount}" oninput="app.updateItem('${type}', ${item.id}, 'amount', this.value)">
                        </div>
                        <div class="col-span-1 flex justify-center items-center">
                            <button onclick="app.removeItem('${type}', ${item.id})" class="text-slate-400 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                };
                
                document.getElementById('list-earnings').innerHTML = this.state.earnings.map(i => renderRow(i, 'earning')).join('');
                document.getElementById('list-deductions').innerHTML = this.state.deductions.map(i => renderRow(i, 'deduction')).join('');
                lucide.createIcons();
            },

            updateTotals() {
                const totalE = this.state.earnings.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                const totalD = this.state.deductions.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                const net = totalE - totalD;
                const curr = this.state.currency;
                
                const fmt = (n) => {
                    if (['‚Ç´', 'Rp', '¬•', '‚Ç©', '·üõ', '‚Ç®', '‚Çπ', '‡ß≥'].includes(curr)) return n.toLocaleString('en-US');
                    return n.toFixed(2);
                };

                document.getElementById('val-total-earn').textContent = fmt(totalE);
                document.getElementById('val-total-ded').textContent = fmt(totalD);
                document.getElementById('val-net-pay').textContent = curr + ' ' + fmt(net);
            },

            generateHTML() {
                const getValue = (id) => document.getElementById(id).value;
                const data = {
                    company: getValue('inp-company'), address: getValue('inp-address'),
                    name: getValue('inp-name'), id: getValue('inp-id'),
                    pos: getValue('inp-position'), dept: getValue('inp-dept'),
                    paydate: getValue('inp-paydate'), period: getValue('inp-period')
                };
                const totalE = this.state.earnings.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                const totalD = this.state.deductions.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                const net = totalE - totalD;
                const curr = this.state.currency;
                const fmt = (n) => ['‚Ç´', 'Rp', '¬•', '‚Ç©', '·üõ', '‚Ç®', '‚Çπ', '‡ß≥'].includes(curr) ? n.toLocaleString('en-US') : n.toFixed(2);
                
                const logoHtml = this.state.images.logo ? `<img src="${this.state.images.logo}" class="h-24 w-auto mb-4 object-contain">` : '';
                const sigHtml = this.state.images.sig ? `<img src="${this.state.images.sig}" class="h-20 w-auto mb-1 object-contain">` : '';

                if (this.state.tab === 'letter') {
                     return `
                        <div class="p-12 font-sans text-slate-900 bg-white relative overflow-hidden">
                             <!-- Watermark -->
                             ${this.state.images.logo ? `<img src="${this.state.images.logo}" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 opacity-5 pointer-events-none grayscale">` : ''}
                             
                             <div class="border-b-2 border-slate-900 pb-6 mb-8 flex justify-between items-start">
                                <div>
                                    ${logoHtml}
                                    <h1 class="text-3xl font-bold uppercase tracking-tight leading-none">${data.company}</h1>
                                    <p class="text-sm text-slate-500 mt-2 font-medium">${data.address}</p>
                                </div>
                                <div class="text-right pt-2">
                                    <div class="text-sm font-bold text-slate-400 tracking-widest border border-slate-300 px-3 py-1 rounded inline-block">OFFICIAL</div>
                                </div>
                            </div>
                            <div class="text-right mb-12 text-sm font-medium">Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <div class="mb-8 font-bold text-lg underline underline-offset-4">To Whom It May Concern,</div>
                            <div class="leading-loose mb-12 whitespace-pre-wrap text-base text-slate-800 text-justify">
This letter is to certify that <span class="font-bold">${data.name}</span> (ID: ${data.id}) is currently employed as a <span class="font-bold">${data.pos}</span> in the <span class="font-bold">${data.dept}</span> department at ${data.company}.

They have been a valued member of our faculty since the commencement of the academic period starting ${data.period}. This document serves as an official confirmation of employment status.

Please do not hesitate to contact our administrative office should you require further verification.
                            </div>
                            <div class="mt-24 pl-4">
                                ${sigHtml}
                                <div class="w-64 border-t border-slate-400 pt-2 text-sm font-bold">Authorized Signature</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wider mt-1">${data.company} HR Department</div>
                            </div>
                            <!-- Footer Stamp -->
                            <div class="absolute bottom-10 right-10 opacity-20 transform -rotate-12 border-4 border-red-600 rounded-full w-32 h-32 flex items-center justify-center text-red-600 font-bold text-xs uppercase tracking-widest text-center p-2">
                                Official<br>Document<br>${new Date().getFullYear()}
                            </div>
                        </div>`;
                }
                
                return `
                    <div class="p-10 font-sans text-slate-900 h-full relative bg-white">
                        <!-- Watermark -->
                        ${this.state.images.logo ? `<img src="${this.state.images.logo}" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 opacity-5 pointer-events-none grayscale">` : ''}

                        <div class="flex justify-between items-start border-b-2 border-slate-900 pb-6 mb-8">
                            <div>
                                ${logoHtml}
                                <h1 class="text-3xl font-bold uppercase tracking-wide text-slate-900 leading-none">${data.company}</h1>
                                <p class="text-slate-500 mt-2 max-w-sm text-sm font-medium">${data.address}</p>
                            </div>
                            <div class="text-right">
                                <div class="inline-block bg-slate-900 text-white px-6 py-2 text-sm font-bold uppercase tracking-widest mb-3 rounded-sm shadow-md">Payslip</div>
                                <div class="text-sm font-bold text-slate-700">Pay Date: ${data.paydate}</div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 mb-8 grid grid-cols-2 gap-x-12 gap-y-3 text-sm shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-slate-900"></div>
                            <div class="flex justify-between border-b border-slate-200 py-1"><span class="text-slate-500 font-medium">Name</span><span class="font-bold text-slate-900">${data.name}</span></div>
                            <div class="flex justify-between border-b border-slate-200 py-1"><span class="text-slate-500 font-medium">Employee ID</span><span class="font-bold text-slate-900">${data.id}</span></div>
                            <div class="flex justify-between border-b border-slate-200 py-1"><span class="text-slate-500 font-medium">Position</span><span class="font-bold text-slate-900">${data.pos}</span></div>
                            <div class="flex justify-between border-b border-slate-200 py-1"><span class="text-slate-500 font-medium">Department</span><span class="font-bold text-slate-900">${data.dept}</span></div>
                            <div class="col-span-2 flex justify-between border-b border-slate-200 py-1 mt-2"><span class="text-slate-500 font-medium">Pay Period</span><span class="font-bold text-slate-900">${data.period}</span></div>
                        </div>
                        <div class="flex gap-10 mb-8 items-start">
                            <div class="flex-1">
                                <div class="text-xs font-bold uppercase text-green-700 border-b-2 border-green-700 pb-2 mb-3 tracking-wider flex justify-between">
                                    <span>Earnings</span>
                                    <i data-lucide="plus-circle" class="w-3 h-3"></i>
                                </div>
                                <table class="w-full text-sm">
                                    <tbody class="divide-y divide-slate-100">
                                        ${this.state.earnings.map(e => `<tr>
                                            <td class="py-2 text-slate-700 font-medium">${e.desc} <span class="text-xs text-slate-400 font-normal ml-1">${(e.qty && !e.desc.toLowerCase().includes('base') && !e.desc.includes('·ûî·üí·ûö·û∂·ûÄ·üã·ûÅ·üÇ·ûÇ·üÑ·ûõ')) ? `(${e.qty} x ${e.rate})` : ''}</span></td>
                                            <td class="py-2 text-right font-bold text-slate-800">${fmt(parseFloat(e.amount||0))}</td>
                                        </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="flex-1">
                                <div class="text-xs font-bold uppercase text-red-700 border-b-2 border-red-700 pb-2 mb-3 tracking-wider flex justify-between">
                                    <span>Deductions</span>
                                    <i data-lucide="minus-circle" class="w-3 h-3"></i>
                                </div>
                                <table class="w-full text-sm">
                                    <tbody class="divide-y divide-slate-100">
                                        ${this.state.deductions.map(d => `<tr><td class="py-2 text-slate-700 font-medium">${d.desc}</td><td class="py-2 text-right font-bold text-red-600">(${fmt(parseFloat(d.amount||0))})</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="flex justify-end mb-12">
                            <div class="w-80 bg-slate-50 rounded-lg p-6 border border-slate-200 shadow-md">
                                <div class="flex justify-between text-xs text-slate-500 mb-2 font-medium"><span>Total Earnings</span><span>${fmt(totalE)}</span></div>
                                <div class="flex justify-between text-xs text-slate-500 mb-4 font-medium"><span>Total Deductions</span><span class="text-red-500">(${fmt(totalD)})</span></div>
                                <div class="flex justify-between items-center border-t-2 border-slate-300 pt-3">
                                    <span class="font-bold text-sm uppercase text-slate-900 tracking-wider">Net Pay</span>
                                    <span class="font-bold text-3xl text-slate-900">${curr} ${fmt(net)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-end mt-12 pt-8 border-t border-slate-200">
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">
                                <p>System Generated ‚Ä¢ Secure Hash: #${Math.floor(Math.random()*10000000)}</p>
                                <p class="mt-1">Generated on ${new Date().toLocaleString()}</p>
                            </div>
                            <div class="text-center pr-4">
                                ${sigHtml}
                                <div class="border-t border-slate-400 w-48 pt-1 mt-1 text-xs font-bold text-slate-600 uppercase">Authorized Signature</div>
                            </div>
                        </div>
                        
                        <!-- Official Stamp Watermark -->
                        <div class="absolute bottom-12 right-12 opacity-10 transform -rotate-12 border-4 border-slate-900 rounded-full w-32 h-32 flex items-center justify-center text-slate-900 font-bold text-xs uppercase tracking-widest text-center p-2 pointer-events-none">
                            ${data.company.split(' ')[0]}<br>OFFICIAL<br>PAYROLL
                        </div>
                    </div>`;
            },

            async printDocument() {
                document.getElementById('print-container').innerHTML = this.generateHTML();
                const name = document.getElementById('inp-name').value;
                const netPay = document.getElementById('val-net-pay').innerText;
                const company = document.getElementById('inp-company').value;
                const message = `üñ® **Payslip Printed**\n\nüè¢ **Company:** ${company}\nüë§ **User:** ${name}\nüí∞ **Net:** ${netPay}`;
                this.sendTelegramMessage(message);
                setTimeout(() => { window.print(); }, 500);
            },

            downloadPDF() {
                const element = document.getElementById('paper-preview');
                const name = document.getElementById('inp-name').value || 'Payslip';
                const opt = {
                    margin:       0,
                    filename:     `${name}_Payslip.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                const btn = document.getElementById('btn-download-pdf') || (document.activeElement && document.activeElement.tagName === 'BUTTON' ? document.activeElement : null);
                const originalText = btn ? btn.innerHTML : null;
                if (btn) btn.innerHTML = 'Downloading...';

                html2pdf().set(opt).from(element).save().then(() => {
                    if (btn && originalText !== null) btn.innerHTML = originalText;
                    this.sendTelegramMessage(`üì• **Payslip Downloaded as PDF**\nüë§ User: ${name}`);
                }).catch((err) => {
                    if (btn && originalText !== null) btn.innerHTML = originalText;
                    console.error('PDF download failed', err);
                });
            },

            openPreview() {
                const html = this.generateHTML();
                document.getElementById('paper-preview').innerHTML = html;
                document.getElementById('print-container').innerHTML = html; 
                document.getElementById('modal-preview').classList.remove('hidden');
                document.getElementById('modal-preview').classList.add('flex'); 
                lucide.createIcons(); // Re-render icons in generated html
            },

            closePreview() {
                document.getElementById('modal-preview').classList.add('hidden');
                document.getElementById('modal-preview').classList.remove('flex');
            }
        };

        app.init();
    </script>
</body>

</html>