<!DOCTYPE html>
<html lang="km">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Analyst | Universal Scanner v15.2 (Optimized)</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Battambang', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        khmer: ['Battambang', 'serif'],
                    },
                    colors: {
                        cyber: {
                            dark: 'var(--bg-primary)',
                            panel: 'var(--bg-panel)',
                            border: 'var(--border-color)',
                            accent: '#06b6d4',
                            danger: '#ef4444',
                            success: '#10b981',
                            warning: '#f59e0b',
                            text: 'var(--text-primary)'
                        }
                    },
                    animation: {
                        'scan': 'scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': {
                                top: '0%',
                                opacity: '0',
                                height: '1px'
                            },
                            '10%': {
                                opacity: '1',
                                height: '2px'
                            },
                            '50%': {
                                opacity: '0.8',
                                height: '4px',
                                boxShadow: '0 0 20px #06b6d4'
                            },
                            '100%': {
                                top: '100%',
                                opacity: '0',
                                height: '1px'
                            },
                        },
                        float: {
                            '0%, 100%': {
                                transform: 'translateY(0)'
                            },
                            '50%': {
                                transform: 'translateY(-5px)'
                            },
                        }
                    }
                }
            }
        }
    </script>

    <style>
         :root {
            --bg-primary: #0a0f1c;
            --bg-panel: rgba(21, 30, 50, 0.9);
            --text-primary: #e2e8f0;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-panel: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --border-color: rgba(6, 182, 212, 0.3);
        }
        
         ::-webkit-scrollbar {
            width: 4px;
        }
        
         ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
         ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 2px;
        }
        
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            background: #06b6d4;
            z-index: 10;
        }
        
        .tech-grid {
            background-image: linear-gradient(rgba(6, 182, 212, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Mobile Fix: Use dvh for dynamic viewport height */
        
        body {
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 100dvh;
        }
        
        @media (min-width: 768px) {
            body {
                overflow: hidden;
            }
        }
    </style>
</head>

<body class="bg-cyber-dark text-cyber-text font-sans min-h-screen flex flex-col transition-colors duration-300">

    <!-- Background -->
    <div class="fixed inset-0 z-0 opacity-20 pointer-events-none" style="background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 30px 30px;">
    </div>

    <!-- Header -->
    <header class="relative z-20 border-b border-cyber-border bg-cyber-dark/95 backdrop-blur-md sticky top-0">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-cyan-500/10 rounded-lg flex items-center justify-center border border-cyan-500/30">
                    <i data-lucide="scan-eye" class="text-cyan-400 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight leading-none">
                        MASTER<span class="text-cyan-400">SCAN</span>
                    </h1>
                    <span class="text-[10px] font-mono text-slate-400 tracking-[0.2em] uppercase">V15.2 PATCHED</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="openContact()" class="p-2 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/30 hover:bg-blue-500/20 transition-all" title="Contact Support">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                </button>
                <button onclick="resetInput()" class="p-2 rounded-lg bg-red-500/10 text-red-400 border border-red-500/30 hover:bg-red-500/20 transition-all" title="New Scan">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
                <button onclick="toggleTheme()" class="p-2 rounded-lg border border-cyber-border hover:bg-cyan-500/10 transition-all">
                    <i data-lucide="moon" class="w-5 h-5" id="themeIcon"></i>
                </button>
                <button onclick="toggleLang()" class="flex items-center gap-1 px-3 py-1.5 rounded-lg border border-cyber-border hover:bg-cyan-500/10 transition-all text-xs font-bold font-khmer">
                    <span id="langLabel">KH</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="relative z-10 flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full p-4 gap-4 h-auto md:h-[calc(100dvh-64px)]">

        <!-- Sidebar Controls -->
        <aside class="w-full md:w-1/3 flex flex-col gap-4 flex-shrink-0 h-auto md:h-full">
            <div class="flex-1 space-y-4">
                <!-- Game Selection -->
                <div class="glass-panel rounded-xl p-4 shadow-xl flex flex-col gap-3">
                    <div class="flex items-center justify-between border-b border-cyber-border pb-2">
                        <label class="text-[10px] font-bold text-cyan-400/80 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="layers" class="w-3 h-3"></i> <span data-i18n="target_module">MODE</span>
                        </label>
                        <span id="currentModeBadge" class="text-[10px] bg-cyan-500/10 text-cyan-500 px-2 py-0.5 rounded border border-cyan-500/20 font-bold font-khmer">Universal</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="game-btn p-3 rounded bg-amber-500/10 text-amber-400 text-xs font-bold flex items-center gap-2 border border-amber-500/30 hover:bg-amber-500/20" onclick="selectGame(this, 'CryptoGold')">
                            <i data-lucide="trending-up" class="w-4 h-4"></i> <span data-i18n="game_cryptogold">Gold & Crypto</span>
                        </button>
                        <button class="game-btn active p-3 rounded bg-cyan-500/10 text-cyan-500 text-xs font-bold flex items-center gap-2 border border-cyan-500/40" onclick="selectGame(this, 'Universal')"><i data-lucide="globe-2" class="w-4 h-4"></i> <span data-i18n="game_universal">Universal</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Kla Klok')"><i data-lucide="dice-5" class="w-4 h-4"></i> <span data-i18n="game_klaklok">Kla Klok</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Baccarat')"><i data-lucide="playing-card" class="w-4 h-4"></i> <span data-i18n="game_baccarat">Baccarat</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Dragon Tiger')"><i data-lucide="sword" class="w-4 h-4"></i> <span data-i18n="game_dt">Dragon Tiger</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Football')"><i data-lucide="trophy" class="w-4 h-4"></i> <span data-i18n="game_football">Football</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Roulette')"><i data-lucide="disc-2" class="w-4 h-4"></i> <span data-i18n="game_roulette">Roulette</span></button>
                        <button class="game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border" onclick="selectGame(this, 'Slots')"><i data-lucide="zap" class="w-4 h-4"></i> <span data-i18n="game_slots">Slots</span></button>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="glass-panel rounded-xl p-1 flex flex-col relative overflow-hidden group shadow-xl min-h-[280px]" id="inputContainer">
                    <div class="absolute inset-0 tech-grid opacity-20 pointer-events-none"></div>

                    <div class="absolute top-2 right-2 z-30 flex gap-1 bg-black/40 p-1 rounded-lg border border-white/10 backdrop-blur">
                        <button onclick="toggleInputMode('upload')" class="p-2 rounded-md bg-cyan-600 text-white transition-all shadow-lg" id="btnUploadMode">
                            <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        </button>
                        <button onclick="toggleInputMode('camera')" class="p-2 rounded-md text-slate-400 hover:text-white transition-all" id="btnCameraMode">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div id="uploadView" class="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-cyber-border m-4 rounded-xl hover:border-cyan-500/50 hover:bg-cyan-500/5 transition-all cursor-pointer relative z-10">
                        <input type="file" id="fileInput" class="hidden" accept="image/*">
                        <div id="uploadPrompt" class="text-center p-4" onclick="triggerFileUpload()">
                            <div class="w-14 h-14 bg-gradient-to-br from-slate-800 to-slate-900 rounded-full flex items-center justify-center mx-auto mb-3 border border-white/10 shadow-lg">
                                <i data-lucide="image-plus" class="w-6 h-6 text-cyan-400"></i>
                            </div>
                            <h3 class="text-sm font-bold text-cyber-text" data-i18n="upload_title">Upload Image</h3>
                            <p class="text-[10px] text-slate-400 font-mono mt-1" data-i18n="upload_desc">Select from Gallery</p>
                        </div>
                    </div>

                    <div id="cameraView" class="hidden absolute inset-0 z-20 bg-black flex flex-col">
                        <video id="cameraFeed" autoplay playsinline class="w-full h-full object-cover"></video>
                        <div class="absolute bottom-4 left-0 right-0 flex justify-center z-30">
                            <button onclick="captureCamera()" class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-white/10 backdrop-blur hover:bg-white/20 transition-all shadow-xl">
                                 <div class="w-12 h-12 bg-cyan-500 rounded-full border-2 border-white"></div>
                             </button>
                        </div>
                        <div id="cameraError" class="hidden absolute inset-0 flex items-center justify-center bg-black/90 text-red-500 p-6 text-center z-40 text-xs font-mono">
                            <i data-lucide="alert-triangle" class="w-8 h-8 mb-2 block mx-auto"></i> Camera Error. Please enable permissions.
                        </div>
                    </div>

                    <div id="previewContainer" class="hidden absolute inset-0 z-40 bg-black flex flex-col">
                        <div class="relative flex-1 overflow-hidden">
                            <img id="imagePreview" src="" class="w-full h-full object-contain opacity-80">
                            <div id="scanLine" class="hidden scan-line animate-scan shadow-[0_0_20px_#06b6d4]"></div>

                            <div id="processingOverlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm hidden">
                                <div class="loader mb-4"></div>
                                <span class="text-cyan-400 font-mono text-xs tracking-widest animate-pulse" data-i18n="status_analyzing">FULL SCAN...</span>
                            </div>
                        </div>
                        <button onclick="resetInput()" class="p-3 bg-red-900/80 text-white text-xs font-bold border-t border-red-500/30 flex items-center justify-center gap-2 hover:bg-red-800 transition-colors">
                            <i data-lucide="x-circle" class="w-4 h-4"></i> <span data-i18n="btn_abort">CANCEL</span>
                        </button>
                    </div>
                </div>
            </div>

            <button onclick="startAnalysis()" id="analyzeBtn" disabled class="w-full py-4 bg-slate-800 text-slate-500 font-bold rounded-xl border border-white/5 shadow-lg flex items-center justify-center gap-3 uppercase tracking-widest text-xs relative overflow-hidden transition-all mt-auto">
                <span class="relative z-10 flex items-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4"></i> <span data-i18n="btn_execute">START ANALYSIS</span>
                </span>
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-600 to-blue-600 opacity-0 transition-opacity duration-300" id="btnGradient"></div>
            </button>
        </aside>

        <!-- Right Panel: Output -->
        <section class="w-full md:w-2/3 glass-panel rounded-xl flex flex-col overflow-hidden shadow-2xl relative h-auto min-h-[500px] md:h-full flex-shrink-0">

            <div class="bg-black/20 p-3 border-b border-cyber-border flex items-center justify-between sticky top-0 z-20 backdrop-blur">
                <div class="flex gap-1.5">
                    <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="clearData()" class="text-[10px] font-mono text-slate-400 hover:text-red-400 transition-colors flex items-center gap-1 cursor-pointer border border-slate-700/50 px-2 py-1 rounded bg-slate-800/30" title="Clear History">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> <span data-i18n="btn_clear">CLEAR DATA</span>
                    </button>
                    <div class="text-[10px] font-mono text-slate-500 flex items-center gap-2">
                        <i data-lucide="terminal" class="w-3 h-3 text-cyan-500"></i> V15.2_SECURE
                    </div>
                </div>
            </div>

            <!-- Console Log -->
            <div id="consoleOutput" class="flex-1 p-6 font-mono text-xs md:text-sm overflow-y-auto space-y-3 scroll-smooth pb-24 bg-black/10">
                <div class="text-slate-500">
                    <span class="text-cyan-500 font-bold">[SYSTEM ONLINE]</span><br> > Core: Active<br> > Modules: Visual Result Generation<br> > Status: Ready.<br>
                    <span class="animate-pulse text-cyan-500 block mt-2">_</span>
                </div>
            </div>

            <!-- Bottom Start Again Button -->
            <div class="absolute bottom-4 left-4 right-4 z-30">
                <button onclick="resetInput()" class="w-full py-3 rounded-lg border border-red-500/30 bg-red-500/10 text-red-400 font-bold text-xs hover:bg-red-500/20 backdrop-blur transition-all flex items-center justify-center gap-2 uppercase tracking-widest shadow-lg">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> <span data-i18n="btn_start_again">START AGAIN</span>
                </button>
            </div>
        </section>
    </main>

    <!-- CONTACT MODAL -->
    <div id="contactModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 relative border border-cyber-border shadow-2xl animate-fade-in">
            <button onclick="closeContact()" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-blue-500/30">
                    <i data-lucide="send" class="w-6 h-6 text-blue-400"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-1" data-i18n="contact_title">Contact Support</h2>
                <p class="text-xs text-slate-400" data-i18n="contact_desc">Send message directly to our Telegram</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1" data-i18n="label_name">Name</label>
                    <input type="text" id="c_name" class="w-full bg-black/40 border border-cyber-border rounded-lg p-3 text-sm text-white focus:border-cyan-500 focus:outline-none transition-colors" placeholder="Your Name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1" data-i18n="label_email">Email / Contact</label>
                    <input type="text" id="c_email" class="w-full bg-black/40 border border-cyber-border rounded-lg p-3 text-sm text-white focus:border-cyan-500 focus:outline-none transition-colors" placeholder="Telegram / Phone">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-1" data-i18n="label_message">Message</label>
                    <textarea id="c_message" rows="3" class="w-full bg-black/40 border border-cyber-border rounded-lg p-3 text-sm text-white focus:border-cyan-500 focus:outline-none transition-colors" placeholder="Describe your issue..."></textarea>
                </div>

                <button onclick="sendFeedback()" id="btnSendMsg" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                    <span data-i18n="btn_send">SEND MESSAGE</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ---
        const API_KEY = "AIzaSyA8CKkypNfDY6tzEWCtRGutwi-x0rBWCC8";
        const TELEGRAM_BOT_ID = "8273106488:AAHHTDMqoZemCK563T-YQMB4arMYl5Ntq-w";
        const CHAT_ID = 1126254088;
        // ---------------------

        // Localization
        const i18n = {
            en: {
                target_module: "SELECT MODE",
                game_universal: "Universal (Auto)",
                game_cryptogold: "Finance (Gold/Crypto)",
                game_klaklok: "Kla Klok",
                game_baccarat: "Baccarat",
                game_dt: "Dragon Tiger",
                game_football: "Football",
                game_roulette: "Roulette",
                game_sicbo: "Sic Bo",
                game_slots: "Slots",
                upload_title: "Upload Image",
                upload_desc: "Select Chart or Game Table",
                btn_abort: "CANCEL",
                btn_execute: "START ANALYSIS",
                btn_start_again: "START NEW SCAN",
                btn_scan_again: "RESCAN",
                btn_clear: "CLEAR DATA",
                status_analyzing: "SCANNING...",
                status_connecting: "CONNECTING TO AI...",
                label_winner: "TARGET / BUY",
                label_avoid: "AVOID / STOP",
                label_risk: "VOLATILITY",
                label_pattern: "PATTERN",
                label_conf: "CONFIDENCE",
                contact_title: "Contact Support",
                contact_desc: "Send us a message directly",
                label_name: "Name",
                label_email: "Contact Info",
                label_message: "Message",
                btn_send: "SEND NOW",
                err_fallback: "Low Confidence / Error. Switched to Simulation Mode."
            },
            kh: {
                target_module: "·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûú·û∑·ûó·û∂·ûÇ",
                game_universal: "·ûü·üí·ûÄ·üÅ·ûì·ûë·ûº·ûë·üÖ (AI Auto)",
                game_cryptogold: "·ûë·û∏·ûï·üí·ûü·û∂·ûö·ûò·û∂·ûü & ·ûÇ·üí·ûö·û∏·ûî·ûè·ûº",
                game_klaklok: "·ûÅ·üí·ûõ·û∂·ûÉ·üí·ûõ·üÑ·ûÄ",
                game_baccarat: "·ûî·û∂·ûÄ·û∂·ûö·üâ·û∂·ûè·üã",
                game_dt: "·ûì·û∂·ûÇ ·ûÅ·üí·ûõ·û∂",
                game_football: "·ûî·û∂·ûõ·üã·ûë·û∂·ûè·üã",
                game_roulette: "·ûö·üâ·ûº·û°·üÇ·ûè",
                game_sicbo: "·û†·û∂·ûô·û°·ûº (Sic Bo)",
                game_slots: "·ûü·üí·ûõ·ûª·ûè (Slots)",
                upload_title: "·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûö·ûº·ûî·ûó·û∂·ûñ",
                upload_desc: "·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûö·ûº·ûî·ûê·ûè·ûñ·û∏ Gallery",
                btn_abort: "·ûî·üÑ·üá·ûî·ûÑ·üã",
                btn_execute: "·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò·ûú·û∑·ûó·û∂·ûÇ",
                btn_start_again: "·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò·ûê·üí·ûò·û∏",
                btn_scan_again: "·ûü·üí·ûÄ·üÅ·ûì·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè",
                btn_clear: "·ûõ·ûª·ûî·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô",
                status_analyzing: "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö·ûú·û∑·ûó·û∂·ûÇ...",
                status_connecting: "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûó·üí·ûá·û∂·ûî·üã·ûë·üÖ AI...",
                label_winner: "·ûÇ·üÑ·ûõ·ûä·üÖ·ûà·üí·ûì·üá (Target)",
                label_avoid: "·ûá·üÄ·ûü·ûú·û∂·ûÑ (Avoid)",
                label_risk: "·ûÄ·ûò·üí·ûö·û∑·ûè·û†·û∂·ûì·û∑·ûó·üê·ûô",
                label_pattern: "·ûî·üí·ûö·ûó·üÅ·ûë·ûõ·üÜ·ûì·û∂·üÜ",
                label_conf: "·ûë·üÜ·ûì·ûª·ûÄ·ûÖ·û∑·ûè·üí·ûè",
                contact_title: "·ûë·û∂·ûÄ·üã·ûë·ûÑ·ûò·ûÄ·ûÄ·û∂·ûì·üã·ûô·ûæ·ûÑ",
                contact_desc: "·ûï·üí·ûâ·ûæ·ûü·û∂·ûö·ûë·üÖ·ûÄ·û∂·ûì·üã Telegram",
                label_name: "·ûà·üí·ûò·üÑ·üá",
                label_email: "·ûõ·üÅ·ûÅ·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë / Telegram",
                label_message: "·ûü·û∂·ûö·ûö·ûî·ûü·üã·û¢·üí·ûì·ûÄ",
                btn_send: "·ûï·üí·ûâ·ûæ·ûü·û∂·ûö·û•·û°·ûº·ûú·ûì·üÅ·üá",
                err_fallback: "AI ·ûò·ûæ·ûõ·ûò·û∑·ûì·ûÖ·üí·ûî·û∂·ûü·üã ·û¨·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·üî ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ·ûÄ·û∂·ûö·ûÇ·ûé·ûì·û∂·ûÄ·üí·ûö·üÖ·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·üî"
            }
        };

        let currentLang = 'kh';
        let currentTheme = 'dark';
        let selectedGame = 'Universal';
        let hasImage = false;
        let stream = null;
        let inputMode = 'upload';

        // DOM Elements
        const els = {
            fileInput: document.getElementById('fileInput'),
            uploadView: document.getElementById('uploadView'),
            cameraView: document.getElementById('cameraView'),
            cameraFeed: document.getElementById('cameraFeed'),
            cameraError: document.getElementById('cameraError'),
            previewContainer: document.getElementById('previewContainer'),
            imagePreview: document.getElementById('imagePreview'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            btnGradient: document.getElementById('btnGradient'),
            consoleOutput: document.getElementById('consoleOutput'),
            scanLine: document.getElementById('scanLine'),
            processingOverlay: document.getElementById('processingOverlay'),
            analysisCanvas: document.getElementById('analysisCanvas'),
            btnUploadMode: document.getElementById('btnUploadMode'),
            btnCameraMode: document.getElementById('btnCameraMode'),
            contactModal: document.getElementById('contactModal'),
            btnSendMsg: document.getElementById('btnSendMsg')
        };

        // --- UI FUNCTIONS ---

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'kh' : 'en';
            document.getElementById('langLabel').innerText = currentLang.toUpperCase();
            updateUIText();
        }

        function updateUIText() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });
            updateBadge();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').setAttribute('data-lucide', currentTheme === 'light' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function selectGame(btn, game) {
            document.querySelectorAll('.game-btn').forEach(b => {
                b.className = "game-btn p-3 rounded bg-slate-500/10 text-slate-400 text-xs font-bold flex items-center gap-2 border border-cyber-border hover:bg-cyan-500/20 cursor-pointer";
            });
            if (game === 'CryptoGold') {
                btn.className = "game-btn active p-3 rounded bg-amber-500/10 text-amber-500 text-xs font-bold flex items-center gap-2 border border-amber-500/40 shadow-lg cursor-default";
            } else {
                btn.className = "game-btn active p-3 rounded bg-cyan-500/10 text-cyan-500 text-xs font-bold flex items-center gap-2 border border-cyan-500/40 shadow-lg cursor-default";
            }

            selectedGame = game;
            updateBadge();
            log(`> Switched to: ${game}`);
        }

        function updateBadge() {
            let key = 'game_' + selectedGame.toLowerCase().replace(' ', '');
            if (selectedGame === 'Dragon Tiger') key = 'game_dt';
            if (selectedGame === 'Kla Klok') key = 'game_klaklok';
            if (selectedGame === 'Gold & Crypto' || selectedGame === 'CryptoGold') key = 'game_cryptogold';

            const badge = document.getElementById('currentModeBadge');
            if (badge) {
                badge.innerText = i18n[currentLang][key] || selectedGame;
                if (selectedGame === 'CryptoGold') {
                    badge.className = "text-[10px] bg-amber-500/10 text-amber-500 px-2 py-0.5 rounded border border-amber-500/20 font-bold font-khmer";
                } else {
                    badge.className = "text-[10px] bg-cyan-500/10 text-cyan-500 px-2 py-0.5 rounded border border-cyan-500/20 font-bold font-khmer";
                }
            }
        }

        function toggleInputMode(mode) {
            inputMode = mode;
            stopCamera();
            if (mode === 'upload') {
                els.uploadView.classList.remove('hidden');
                els.cameraView.classList.add('hidden');
                updateToggleStyle(els.btnUploadMode, els.btnCameraMode);
            } else {
                els.uploadView.classList.add('hidden');
                els.cameraView.classList.remove('hidden');
                updateToggleStyle(els.btnCameraMode, els.btnUploadMode);
                startCamera();
            }
        }

        function updateToggleStyle(active, inactive) {
            active.className = "p-2 rounded-md bg-cyan-600 text-white transition-all shadow-lg";
            inactive.className = "p-2 rounded-md text-slate-400 hover:text-white transition-all";
        }

        function clearData() {
            els.consoleOutput.innerHTML = '';
            const initMsg = document.createElement('div');
            initMsg.className = "text-slate-500";
            initMsg.innerHTML = `<span class="text-cyan-500 font-bold">[SYSTEM RESET]</span><br>> Memory Cleared.<br>> Ready for new analysis.<br><span class="animate-pulse text-cyan-500 block mt-2">_</span>`;
            els.consoleOutput.appendChild(initMsg);
            resetInput();
            log('> Data cleared successfully.');
        }

        function openContact() {
            els.contactModal.classList.remove('hidden');
        }

        function closeContact() {
            els.contactModal.classList.add('hidden');
        }

        function sendFeedback() {
            const name = document.getElementById("c_name").value;
            const email = document.getElementById("c_email").value;
            const message = document.getElementById("c_message").value;
            const btn = els.btnSendMsg;

            if (!name || !message) {
                alert("Please fill in Name and Message.");
                return;
            }

            // Simple Anti-Spam: Disable button temporarily
            btn.disabled = true;
            btn.innerText = "SENDING...";

            const text = `üì¨ New Support Request:\n\nüë§ Name: ${name}\nüìß Contact: ${email}\nüí¨ Message: ${message}`;

            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_ID}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: text
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        alert("Message sent successfully!");
                        document.getElementById("c_name").value = "";
                        document.getElementById("c_email").value = "";
                        document.getElementById("c_message").value = "";
                        closeContact();
                    } else {
                        alert("Failed to send message. Bot might be offline.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error sending message.");
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<span data-i18n="btn_send">SEND MESSAGE</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                });
        }

        // --- CAMERA & FILE ---

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment'
                    }
                });
            } catch (err) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                } catch (e) {
                    return;
                }
            }
            if (stream) {
                els.cameraFeed.srcObject = stream;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                els.cameraFeed.srcObject = null;
            }
        }

        function captureCamera() {
            if (!stream) return;
            const canvas = document.createElement('canvas');
            canvas.width = els.cameraFeed.videoWidth;
            canvas.height = els.cameraFeed.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(els.cameraFeed, 0, 0);
            els.imagePreview.src = canvas.toDataURL('image/jpeg', 0.8);
            stopCamera();
            els.cameraView.classList.add('hidden');
            els.previewContainer.classList.remove('hidden');
            hasImage = true;
            enableAnalyzeBtn();
        }

        function triggerFileUpload() {
            if (!hasImage) els.fileInput.click();
        }
        els.fileInput.addEventListener('change', () => {
            if (els.fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    els.imagePreview.src = e.target.result;
                    els.previewContainer.classList.remove('hidden');
                    hasImage = true;
                    enableAnalyzeBtn();
                };
                reader.readAsDataURL(els.fileInput.files[0]);
            }
        });

        function resetInput() {
            els.fileInput.value = '';
            els.previewContainer.classList.add('hidden');
            hasImage = false;
            disableAnalyzeBtn();
            els.processingOverlay.classList.add('hidden');
            if (inputMode === 'camera') {
                els.uploadView.classList.add('hidden');
                els.cameraView.classList.remove('hidden');
                startCamera();
            } else {
                els.cameraView.classList.add('hidden');
                els.uploadView.classList.remove('hidden');
            }
            log('> Ready.');
        }

        function enableAnalyzeBtn() {
            els.analyzeBtn.disabled = false;
            els.analyzeBtn.classList.remove('cursor-not-allowed', 'text-slate-500');
            els.analyzeBtn.classList.add('text-white', 'cursor-pointer', 'hover:scale-[1.01]');
            els.btnGradient.classList.remove('opacity-0');
            els.btnGradient.classList.add('opacity-100');
        }

        function disableAnalyzeBtn() {
            els.analyzeBtn.disabled = true;
            els.analyzeBtn.classList.add('cursor-not-allowed', 'text-slate-500');
            els.analyzeBtn.classList.remove('text-white', 'cursor-pointer', 'hover:scale-[1.01]');
            els.btnGradient.classList.remove('opacity-100');
            els.btnGradient.classList.add('opacity-0');
        }

        async function startAnalysis() {
            if (!hasImage) return;
            disableAnalyzeBtn();
            els.scanLine.classList.remove('hidden');
            els.processingOverlay.classList.remove('hidden');
            log('> AI SCANNING...');

            // Timeout Protection (5s limit to fallback)
            const timeoutPromise = new Promise(resolve => setTimeout(() => resolve(null), 15000));

            let apiResult = await Promise.race([
                callGeminiAPI(els.imagePreview.src, 0, false),
                timeoutPromise
            ]);

            if (!apiResult) {
                log('> Standard Model Timeout. Switching to Legacy...');
                apiResult = await callGeminiAPI(els.imagePreview.src, 0, true);
            }

            els.scanLine.classList.add('hidden');
            els.processingOverlay.classList.add('hidden');
            enableAnalyzeBtn();

            if (apiResult) {
                log('> Analysis Successful.');
                renderResult(apiResult);
            } else {
                log('> Connection Failed. Showing Sim Data.');
                renderResult(generateFallbackPrediction());
            }
        }

        async function callGeminiAPI(base64Str, retryCount = 0, useFallbackModel = false) {
            const modelName = useFallbackModel ? 'gemini-1.5-flash' : 'gemini-2.5-flash-preview-09-2025';
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

            let prompt = "";

            if (selectedGame === 'CryptoGold') {
                prompt = `Role: Senior Financial Analyst.
                Task: Analyze the CHART IMAGE. Identify Trend, Support/Resistance, RSI/MACD.
                Output: ${currentLang === 'kh' ? 'Khmer' : 'English'}.
                Constraint: Professional Trading Terms.
                JSON Format: { 
                    "analysis": "Technical analysis details in Khmer...", 
                    "hot": "BUY (·ûë·û∑·ûâ) / SELL (·ûõ·ûÄ·üã)", 
                    "hotVal": 90, 
                    "cold": "STOP LOSS @", 
                    "coldVal": 10, 
                    "advice": "Entry Price: ... Take Profit: ...", 
                    "volatility": "High/Low",
                    "patternName": "Chart Pattern (e.g. Bullish Flag)",
                    "meta": {"tableId": "TF: H1/H4", "dealer": "Asset"} 
                }`;
            } else if (selectedGame === 'Football') {
                prompt = `Role: Football Match Analyst.
                Task: Analyze the SCOREBOARD or MATCH ODDS image. Identify teams, score, and time.
                Output: ${currentLang === 'kh' ? 'Khmer' : 'English'}.
                Constraint: Predict Winner based on form/odds shown.
                JSON Format: { 
                    "analysis": "Match analysis: Team A vs Team B...", 
                    "hot": "HOME / AWAY / DRAW", 
                    "hotVal": 85, 
                    "cold": "OPPONENT", 
                    "coldVal": 15, 
                    "advice": "Betting tip: Over 2.5 / HDP...", 
                    "volatility": "High/Low", 
                    "patternName": "Form Guide", 
                    "meta": {"tableId": "League", "dealer": "Time"} 
                }`;
            } else if (selectedGame === 'Kla Klok') {
                prompt = `Role: Kla Klok Expert. Task: Count symbols (Tiger, Gourd, Rooster, Shrimp, Crab, Fish). Output: ${currentLang === 'kh' ? 'Khmer' : 'English'}. JSON Format: { "analysis": "Found: 2 Tiger, 1 Fish...", "hot": "Tiger", "hotVal": 90, "cold": "Fish", "coldVal": 10, "advice": "Bet on Tiger...", "volatility": "Medium", "patternName": "Repeat", "meta": {"tableId": "KK", "dealer": "Dice"} }`;
            } else {
                prompt = `Role: Senior Casino Analyst. Task: Analyze gambling image (${selectedGame}). Output: ${currentLang === 'kh' ? 'Khmer' : 'English'}. Constraint: High Confidence >80%. Use specific terms like "·ûü·üä·üÅ·ûö·û∏", "·ûè·û∂·ûö·û∂·ûÑ". JSON Format: { "analysis": "...", "hot": "Winner", "hotVal": 90, "cold": "Loser", "coldVal": 10, "advice": "...", "volatility": "Risk Level", "patternName": "Streak Type", "meta": {"tableId": "...", "dealer": "..."} }`;
            }

            try {
                const mimeType = base64Str.substring(5, base64Str.indexOf(';'));
                const data = base64Str.split(',')[1];
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }, {
                                inline_data: {
                                    mime_type: mimeType,
                                    data: data
                                }
                            }]
                        }]
                    })
                });

                if (response.status === 503 && retryCount < 2) {
                    await new Promise(r => setTimeout(r, 2000));
                    return callGeminiAPI(base64Str, retryCount + 1, useFallbackModel);
                }
                if (!response.ok) return null;
                const json = await response.json();
                const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                return JSON.parse(text);
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function renderResult(data) {
            const vol = data.volatility || "Medium";
            const pat = data.patternName || "Unknown";
            const labels = i18n[currentLang];

            let hotColor = "text-green-400";
            let hotLabel = labels.label_winner;
            let coldLabel = labels.label_avoid;

            let resultVisual = "";

            // GENERATE VISUAL GRAPHIC BASED ON RESULT
            if (selectedGame === 'CryptoGold') {
                hotLabel = currentLang === 'kh' ? "·ûü·ûâ·üí·ûâ·û∂ (SIGNAL)" : "SIGNAL";
                coldLabel = currentLang === 'kh' ? "·ûÄ·û∂·ûè·üã·ûÅ·û∂·ûè (STOP)" : "STOP LOSS";
                const isBuy = data.hot.includes("BUY") || data.hot.includes("·ûë·û∑·ûâ");
                if (!isBuy) hotColor = "text-red-400";
                resultVisual = `<div class="flex items-center justify-center py-4"><div class="w-24 h-24 rounded-full border-4 ${isBuy ? 'border-green-500 bg-green-500/10' : 'border-red-500 bg-red-500/10'} flex items-center justify-center animate-float"><i data-lucide="${isBuy ? 'arrow-up' : 'arrow-down'}" class="w-12 h-12 ${isBuy ? 'text-green-400' : 'text-red-400'}"></i></div></div>`;
            } else if (selectedGame === 'Football') {
                hotLabel = currentLang === 'kh' ? "·ûÄ·üí·ûö·ûª·ûò·ûà·üí·ûì·üá (WINNER)" : "WINNER";
                let isHome = data.hot.includes("HOME") || data.hot.includes("·ûò·üí·ûÖ·û∂·ûü·üã·ûï·üí·ûë·üá");
                let isAway = data.hot.includes("AWAY") || data.hot.includes("·ûó·üí·ûâ·üÄ·ûú");
                let visualText = isHome ? "1" : (isAway ? "2" : "X");
                resultVisual = `<div class="flex items-center justify-center py-4"><div class="w-24 h-24 rounded-lg border-4 border-white bg-green-600 flex items-center justify-center shadow-2xl animate-pulse"><span class="text-5xl font-bold text-white font-mono">${visualText}</span></div></div>`;
            } else if (selectedGame === 'Kla Klok') {
                let icon = "help-circle";
                resultVisual = `<div class="flex items-center justify-center py-4"><div class="text-center"><div class="text-6xl animate-bounce">üé≤</div><div class="text-xl font-bold text-cyan-400 mt-2">${data.hot}</div></div></div>`;
            } else {
                const isPlayer = data.hot.includes("Player") || data.hot.includes("Blue");
                const colorClass = isPlayer ? "bg-blue-600" : "bg-red-600";
                const textVal = isPlayer ? "P" : "B";
                resultVisual = `<div class="flex items-center justify-center py-4"><div class="w-20 h-20 rounded-full ${colorClass} border-4 border-white flex items-center justify-center text-4xl font-bold text-white shadow-2xl animate-pulse">${textVal}</div></div>`;
            }

            const div = document.createElement('div');
            div.className = "mt-4 bg-slate-800/50 rounded-lg border border-cyan-500/30 p-4 relative overflow-hidden animate-fade-in pb-4";
            div.innerHTML = `
                <button onclick="resetInput()" class="absolute top-2 right-2 p-2 rounded-lg bg-red-500/10 text-red-400 border border-red-500/30 hover:bg-red-500/20 z-20">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
                
                <!-- SCANNED IMAGE THUMBNAIL -->
                <div class="w-full mb-4 rounded-lg overflow-hidden border border-white/10 relative">
                   <img src="${els.imagePreview.src}" class="w-full h-24 object-cover opacity-60">
                   <div class="absolute inset-0 flex items-center justify-center"><span class="bg-black/60 px-2 py-1 rounded text-[10px] text-white">Scanned Image</span></div>
                </div>

                <div class="flex items-center gap-2 mb-3 border-b border-white/5 pb-2 relative z-10 pr-10">
                    <i data-lucide="shield-check" class="text-cyan-400 w-4 h-4"></i>
                    <span class="text-cyan-400 font-bold text-sm uppercase">Result: ${selectedGame}</span>
                </div>
                
                <!-- GENERATED VISUAL RESULT -->
                ${resultVisual}

                <div class="font-khmer space-y-3 text-slate-200 text-sm">
                    <div class="p-3 bg-cyan-900/10 rounded border-l-2 border-cyan-500 text-xs leading-relaxed">
                        ${data.analysis}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-green-900/10 p-2 rounded border border-green-500/20 relative overflow-hidden">
                            <div class="absolute inset-0 bg-green-500/5 animate-pulse-fast"></div>
                            <div class="relative z-10">
                                <div class="text-[10px] text-green-400 font-bold uppercase">${hotLabel}</div>
                                <div class="font-bold text-lg text-white ${hotColor}">${data.hot}</div>
                                <div class="text-[9px] text-green-400 flex items-center gap-1">
                                    <i data-lucide="trending-up" class="w-3 h-3"></i> ${labels.label_conf}: ${data.hotVal}%
                                </div>
                            </div>
                        </div>
                        <div class="bg-red-900/10 p-2 rounded border border-red-500/20">
                            <div class="text-[10px] text-red-400 font-bold uppercase">${coldLabel}</div>
                            <div class="font-bold text-lg text-white">${data.cold}</div>
                            <div class="text-[9px] text-red-400">Risk: ${data.coldVal}%</div>
                        </div>
                    </div>
                    <div class="p-3 bg-yellow-500/5 rounded border border-yellow-500/20 text-yellow-100 italic flex gap-2 items-start">
                        <i data-lucide="lightbulb" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                        <span class="text-xs">${data.advice}</span>
                    </div>
                </div>
            `;
            els.consoleOutput.appendChild(div);
            lucide.createIcons();
            els.consoleOutput.scrollTop = els.consoleOutput.scrollHeight;
        }

        function generateFallbackPrediction() {
            return {
                analysis: i18n[currentLang].err_fallback,
                hot: "Hold",
                hotVal: 50,
                cold: "Wait",
                coldVal: 50,
                advice: currentLang === 'kh' ? "·ûü·ûº·ûò·ûö·ûÑ·üã·ûÖ·û∂·üÜ·ûî·ûì·üí·ûè·û∑·ûÖ ·û†·ûæ·ûô·ûñ·üí·ûô·û∂·ûô·û∂·ûò·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè·üî" : "Please wait and retry.",
                meta: {
                    tableId: "OFFLINE",
                    dealer: "Sim"
                },
                volatility: "Unknown",
                patternName: "Random"
            };
        }

        function log(msg) {
            const p = document.createElement('div');
            p.className = "border-l-2 border-slate-700 pl-2 py-0.5";
            p.innerHTML = `<span class="text-slate-500 mr-2 text-[10px]">[LOG]</span><span class="text-cyan-500/90 text-xs">${msg}</span>`;
            els.consoleOutput.appendChild(p);
        }

        updateUIText();
        setTimeout(() => log('System V15.2 Ready. Optimized & Secured.'), 500);
    </script>
</body>

</html>